CREATE DATABASE SV_20521569
DROP DATABASE SV_20521569
USE SV_20521569

--CÂU 1: VIẾT CÂU LỆNH SQL TẠO CÁC QUAN HỆ TRÊN (KÈM KHÓA CHÍNH) VỚI CÁC DỮ KIỂU LIỆU MÔ TẢ TRONG BẢNG MÔ TẢ
--MỨC ĐỘ: DỄ
--CHI TIẾT:
CREATE TABLE XETAI(
	MAXE CHAR(10),
	MALX CHAR(4),
	NGMUA SMALLDATETIME,
	SOKM INT
	PRIMARY KEY(MAXE)
)

CREATE TABLE LOAIXE(
	MALX CHAR(4),
	TENLX NVARCHAR(20),
	NHASX NVARCHAR(20),
	TAITRONG INT,
	NIENHAN INT
	PRIMARY KEY(MALX)
)

CREATE TABLE TAIXE(
	MATX CHAR(4),
	HOTEN NVARCHAR(50),
	NGAYVL SMALLDATETIME
	PRIMARY KEY(MATX)
)

CREATE TABLE BANGLAI(
	MABL CHAR(4),
	MATX CHAR(4),
	NGCAP SMALLDATETIME,
	LOAI CHAR(2)
	PRIMARY KEY(MABL)
)


CREATE TABLE VANCHUYEN(
	MAVC CHAR(4),
	MATX CHAR(4),
	MAXE CHAR(10),
	KLUONG INT,
	QDUONG INT,
	NGVC SMALLDATETIME
	PRIMARY KEY(MAVC)
)

--CÂU 2: TẠO RÀNG BUỘC KHÓA NGOẠI
--MỨC ĐỘ: DỄ
--CHI TIẾT:

ALTER TABLE XETAI ADD CONSTRAINT FK_XETAI FOREIGN KEY(MALX) REFERENCES LOAIXE(MALX)
ALTER TABLE BANGLAI ADD CONSTRAINT FK_BANGLAI FOREIGN KEY(MATX) REFERENCES TAIXE(MATX)
ALTER TABLE VANCHUYEN ADD CONSTRAINT FK_VANCHUYEN_MATX FOREIGN KEY(MATX) REFERENCES TAIXE(MATX)
ALTER TABLE VANCHUYEN ADD CONSTRAINT FK_VANCHUYEN_MAXE FOREIGN KEY(MAXE) REFERENCES XETAI(MAXE)

--CÂU 3:ĐÔI VỚI MỖI QUAN HỆ, XÁC ĐỊNH THÊM 1 RÀNG BUỘC
--MỨC ĐỘ: DỄ
--CHI TIẾT:

ALTER TABLE XETAI 
ADD CONSTRAINT CK_SOKM CHECK(SOKM >=0)

ALTER TABLE LOAIXE
ADD CONSTRAINT CK_TAITRONG CHECK(TAITRONG >=0)

ALTER TABLE TAIXE 
ADD CONSTRAINT CK_NGAYVL CHECK(YEAR(GETDATE()) - YEAR(NGAYVL) >= 0)

ALTER TABLE BANGLAI 
ADD CONSTRAINT CK_NGCAP CHECK(YEAR(GETDATE()) - YEAR(NGCAP) >= 0)

ALTER TABLE VANCHUYEN 
ADD CONSTRAINT CK_KLUONG CHECK(KLUONG >= 0)

--CÂU 4: CẬP NHẬT DỮ LIỆU
--MỨC ĐỘ: DỄ
--CHI TIẾT:
SET DATEFORMAT DMY

INSERT INTO TAIXE(MATX, HOTEN, NGAYVL) VALUES('T001', N'Phạm Văn Hai', '15/10/2019')
INSERT INTO TAIXE(MATX, HOTEN, NGAYVL) VALUES('T002', N'Nguyễn Văn Thanh', '18/12/2020')
INSERT INTO TAIXE(MATX, HOTEN, NGAYVL) VALUES('T003', N'Lê Hồng Phát', '25/7/2018')
INSERT INTO TAIXE(MATX, HOTEN, NGAYVL) VALUES('T004', N'Nguyễn Ngọc Tâm', '5/3/2017')
INSERT INTO TAIXE(MATX, HOTEN, NGAYVL) VALUES('T005', N'Trần Văn Tân', '1/6/2021')

INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X002', N'Trường Phát', N'Việt Nam', 8, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X004', N'Hoàng Long', N'Thái Lan', 15, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X006', N'Phong Thuận', N'Hàn Quốc', 10, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X008', N'Nhơn Hỏa', N'Nhật Bản', 20, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X010', N'Phượng Hoàng', N'LB Đức', 9, 5)

INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M001', 'X010', '20/1/2017', 1500)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M003', 'X008', '22/7/2019', 1743)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M005', 'X006', '26/3/2018', 9745)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M007', 'X004', '21/8/2017', 4577)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M009', 'X002', '25/9/2016', 9632)

INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B001', 'T001', '10/11/2015', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B002', 'T002', '24/12/2014', 'C1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B003', 'T003', '17/10/2016', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B004', 'T004', '26/11/2018', 'E1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B005', 'T005', '29/12/2017', 'D3')

INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V006', 'T001', 'M001', 9, 100, '7/12/2019')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V007', 'T005', 'M005', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V008', 'T003', 'M009', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V009', 'T002', 'M003', 9, 100, '7/12/2022')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V010', 'T001', 'M007', 9, 100, '7/12/2021')

--CÂU 5:
-- MÔ TẢ: LIỆT KÊ THÔNG TIN(MAXE, TENLX, NHASX, NIENHAN) CỦA NHỮNG CHIẾC XE MÀ CÔNG TY MUA NĂM 2017
	-- KHÔNG DÙNG DẤU =
--MỨC ĐỘ: DỄ
--BẢNG: LOAIXE, TAIXE
--CHI TIẾT:

SELECT MAXE, TENLX, NHASX, NIENHAN
FROM LOAIXE INNER JOIN XETAI ON LOAIXE.MALX = XETAI.MALX
WHERE YEAR(NGMUA) IN(2017)

-- CÂU 6: 
--MÔ TẢ: LIỆT KÊ NHỮNG (MATX, TENTX) CÓ BẰNG LÁI XE LOẠI "D1" ĐƯỢC CẤP NĂM 2015,2016 (KHÔNG DÙNG IN)
--MỨC ĐỘ: DỄ
--BẢNG: TAIXE, BANGLAI
--CHI TIẾT:

SELECT TAIXE.MATX, HOTEN
FROM TAIXE INNER JOIN BANGLAI ON TAIXE.MATX = BANGLAI.MATX
WHERE LOAI ='D1' AND (YEAR(NGCAP) = 2015 OR YEAR(NGCAP) = 2016)

--CÂU 7: 
--MÔ TẢ: TÌM XE(MAXE) CÓ TỔNG QUÃNG ĐƯỜNG VẬN CHUYỂN LỚN NHẤT
--MỨC ĐỘ: VỪA
--BẢNG: VANCHUYEN
--CHI TIẾT:

SELECT TOP 1 WITH TIES
MAXE, SUM(QDUONG) TONGQDUONG
FROM VANCHUYEN 
GROUP BY MAXE
ORDER BY SUM(QDUONG) DESC

--CÂU 8: 
-- MÔ TẢ: TÌM TÀI XẾ(MATX,TENTX) LÁI ĐƯỢC TẤT CẢ CÁC XE
--MỨC ĐỘ: VỪA
--BẢNG:TAIXE, XETAI, VANCHUYEN
-- CHI TIẾT:

SELECT TAIXE.MATX, HOTEN
FROM VANCHUYEN INNER JOIN TAIXE ON VANCHUYEN.MATX = TAIXE.MATX
				INNER JOIN XETAI ON VANCHUYEN.MAXE = XETAI.MAXE
GROUP BY TAIXE.MATX, HOTEN
HAVING COUNT(DISTINCT XETAI.MAXE) = 
	(
		SELECT COUNT(MAXE) FROM XETAI
	)


--CÂU 9:
-- MÔ TẢ: RÀNG BUỘC NGÀY VẬN CHUYỂN HÀNG PHẢI SAU NGÀY MUA XE
-- MỨC ĐỘ: KHÓ
-- RB: NGVC >= NGMUA
--CHI TIẾT:
CREATE TRIGGER CAU9
ON VANCHUYEN
FOR INSERT,UPDATE
AS
BEGIN
DECLARE @NGVC SMALLDATETIME, @NGMUA SMALLDATETIME
SELECT @NGVC = NGVC 
FROM INSERTED 
SELECT @NGMUA = NGMUA
FROM INSERTED,XETAI
WHERE INSERTED.MAXE = XETAI.MAXE

IF(@NGMUA >= @NGVC)
BEGIN
	PRINT N'NGÀY VẬN CHUYỂN PHẢI SAU NGÀY MUA'
	ROLLBACK TRANSACTION
END
ELSE
	PRINT N'THÀNH CÔNG'
END

--CÂU 10: 
--MÔ TẢ: RÀNG BUỘC THỜI GIAN KHỐI LƯỢNG VẬN CHUYỂN(KLUONG) KHÔNG QUÁ TẢI TRỌNG(TAITRONG) 50% CỦA XE
--MỨC ĐỘ: KHÓ
--RB: KLUONG <= 50% TAITRONG
--CHI TIẾT:
CREATE TRIGGER CAU10
ON VANCHUYEN 
FOR INSERT, UPDATE
AS
DECLARE @KLUONG INT, @TAITRONG INT
SELECT @KLUONG = KLUONG FROM inserted 
SELECT @TAITRONG = TAITRONG FROM inserted, XETAI,LOAIXE
WHERE inserted.MAXE = XETAI.MAXE AND XETAI.MALX = LOAIXE.MALX
IF(@KLUONG *2 > @TAITRONG)
BEGIN 
	PRINT N'KHOI LUONG PHAI BE HON 50 % TAITRONG'
	ROLLBACK TRAN
END
ELSE
	PRINT N'THANHCONG'


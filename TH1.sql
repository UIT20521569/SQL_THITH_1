CREATE DATABASE TH1
DROP DATABASE TH1
USE TH1
--Câu 1. Viết các câu lệnh SQL tạo các quan hệ trên (kèm khóa chính) với các kiểu dữ liệu mô tả trong bảng mô tả
-- Mức độ: Dễ
CREATE TABLE NHANVIEN(
	MANV	CHAR(4),
	HOTEN	NVARCHAR(50),
	NGSINH	SMALLDATETIME,
	DCHI	NVARCHAR(50),
	GTINH	NVARCHAR(4),
	LUONG	MONEY,
	MAPHG	CHAR(5)
	PRIMARY KEY(MANV)
)

CREATE TABLE PHONGBAN(
	MAPHG CHAR(5),
	TENPHG NVARCHAR(50),
	NGTL SMALLDATETIME
	PRIMARY KEY (MAPHG)
)

CREATE TABLE NHANSU(
	MANV CHAR(4),
	MAPHG CHAR(5),
	CHUCVU NVARCHAR(4),
	NGVL SMALLDATETIME
	PRIMARY KEY(MANV,MAPHG)
)

CREATE TABLE DEAN(
	MADA CHAR(10),
	MAPHG CHAR(5),
	TENDA NVARCHAR(100),
	NGBD SMALLDATETIME,
	NGKT SMALLDATETIME
	PRIMARY KEY(MADA)
)

CREATE TABLE PHANCONG(
	MANV CHAR(4),
	MADA CHAR(10),
	THOIGIAN SMALLDATETIME
	PRIMARY KEY(MADA, MANV)
)

--Câu 2. Anh/chị hãy tạo các ràng buộc khóa ngoại (7 hoặc 8 khóa).
--Mức độ: Dễ
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPHG)
ALTER TABLE NHANSU ADD CONSTRAINT FK_NHANSU_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE NHANSU ADD CONSTRAINT FK_NHANSU FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPHG)
ALTER TABLE DEAN ADD CONSTRAINT FK_DEAN FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPHG)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_MADA FOREIGN KEY(MADA) REFERENCES DEAN(MADA)


--Câu 3: Đối với mỗi quan hệ, anh/chị xác định thêm 1 ràng buộc.
-- Mức độ: DỄ
ALTER TABLE NHANVIEN
ADD CONSTRAINT CK_LUONG CHECK (LUONG > 0)

ALTER TABLE PHONGBAN
ADD CONSTRAINT CK_NGTL CHECK
(
	YEAR(GETDATE()) - YEAR(NGTL) >= 0 
)

ALTER TABLE NHANSU
ADD CONSTRAINT CK_NGVL CHECK
(
	YEAR(GETDATE()) - YEAR(NGVL) >= 0 
)

ALTER TABLE DEAN
ADD CONSTRAINT CK_NGVL_NGKT CHECK(NGBD < NGKT)

ALTER TABLE PHANCONG
ADD CONSTRAINT CK_THOIGIAN CHECK(
	YEAR(GETDATE()) - YEAR(THOIGIAN) >= 0
)

--Câu 4: Cập nhật dữ liệu Click.
--Mức độ: DỄ
SET DATEFORMAT DMY

INSERT INTO PHONGBAN(MAPHG, TENPHG, NGTL) VALUES ('001', N'Phòng Tổ chức Cán bộ', '8/6/2005')
INSERT INTO PHONGBAN(MAPHG, TENPHG, NGTL) VALUES ('002', N'Phòng Hành Chính', '18/1/2006')
INSERT INTO PHONGBAN(MAPHG, TENPHG, NGTL) VALUES ('003', N'Phòng Tài Chính', '27/9/2007')
INSERT INTO PHONGBAN(MAPHG, TENPHG, NGTL) VALUES ('004', N'Phòng Khoa học Công nghệ', '20/5/2008')
INSERT INTO PHONGBAN(MAPHG, TENPHG, NGTL) VALUES ('005', N'Phòng Quản trị', '15/9/2009')

INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, DCHI, GTINH, LUONG, MAPHG) VALUES ('N001', N'Phạm Thanh Long', '8/6/2000', N'Cà Mau', N'Nam', 9000000, '001')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, DCHI, GTINH, LUONG, MAPHG) VALUES ('N002', N'Nguyễn Thanh Thanh', '18/3/2001', N'Bạc Liêu', N'Nữ', 8000000, '002')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, DCHI, GTINH, LUONG, MAPHG) VALUES ('N003', N'Võ Ngọc Thành', '28/7/2002', N'An Giang', N'Nam', 5000000, '003')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, DCHI, GTINH, LUONG, MAPHG) VALUES ('N004', N'Nguyễn Thị Hoa', '26/9/2001', N'Long An', N'Nữ', 9500000, '004')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, DCHI, GTINH, LUONG, MAPHG) VALUES ('N005', N'Lâm Thị Huệ', '13/1/2000', N'Tp.HCM', N'Nữ', 7500000, '005')

INSERT INTO NHANSU(MANV, MAPHG, CHUCVU, NGVL) VALUES('N001', '001', N'GĐ', '15/9/2010')
INSERT INTO NHANSU(MANV, MAPHG, CHUCVU, NGVL) VALUES('N002', '002', N'QL', '20/4/2011')
INSERT INTO NHANSU(MANV, MAPHG, CHUCVU, NGVL) VALUES('N003', '003', N'TP', '12/6/2012')

INSERT INTO DEAN(MADA, MAPHG, TENDA, NGBD, NGKT) VALUES('DA001', '001', N'Quản Lý Tàu', '15/1/2020', '15/9/2020')
INSERT INTO DEAN(MADA, MAPHG, TENDA, NGBD, NGKT) VALUES('DA002', '002', N'Quản Lý Giao Thông', '10/2/2020', '18/8/2020')
INSERT INTO DEAN(MADA, MAPHG, TENDA, NGBD, NGKT) VALUES('DA003', '003', N'Xây dựng Trại', '11/3/2020', '11/5/2020')

INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES('N003', 'DA003', '15/1/2020')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES('N002', 'DA003', '15/2/2020')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES('N004', 'DA001', '16/3/2020')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES('N005', 'DA002', '15/2/2020')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES('N001', 'DA003', '15/1/2020')
--Câu 5. Liệt kê các nhân viên (MANV, HOTEN) tham gia đề án có mã đề án là "DA001" hoặc "DA003". (Chú ý không dùng in)
--Bảng: NHANVIEN
--Mức độ: DỄ

SELECT NHANVIEN.MANV, HOTEN
FROM NHANVIEN INNER JOIN PHANCONG ON NHANVIEN.MANV = PHANCONG.MANV
WHERE MADA = 'DA001' OR MADA ='DA003'

--Câu 6. Liệt kê các nhân viên (MANV, HOTEN, NGSINH) là nhân sự của phòng ban có mã phòng ban là "003" và ngày vào làm sau ngày 01/01/2010.
--Bảng: NHANVIEN
--Mức độ: DỄ

SELECT NHANVIEN.MANV, HOTEN, NGSINH
FROM PHONGBAN INNER JOIN NHANVIEN ON NHANVIEN.MAPHG = PHONGBAN.MAPHG
	 INNER JOIN NHANSU ON PHONGBAN.MAPHG = NHANSU.MAPHG
WHERE PHONGBAN.MAPHG = '003' AND NGVL ='01/01/2010'

--Câu 7. Tìm phòng ban (MAPHG) có số lượng nhân viên ít nhất
--Bảng: PHONGBAN
--Mức độ: Vừa
SELECT MAPHG 
FROM NHANVIEN
GROUP BY MAPHG
HAVING COUNT(MANV) =
(
	SELECT MIN(SL_NV)
	FROM
	(
		SELECT MAPHG,COUNT(MANV) AS SL_NV
		FROM NHANVIEN
		GROUP BY MAPHG
	)AS T
)

-- Câu 8. Cho biết nhân viên (MANV, TENNV) được phân công tham gia tất cả các đề án
--Bảng: NHANVIEN
--Mức độ: VỪA

SELECT NHANVIEN.MANV, HOTEN
FROM NHANVIEN INNER JOIN PHANCONG ON NHANVIEN.MANV = PHANCONG.MANV
GROUP BY NHANVIEN.MANV, HOTEN
HAVING COUNT(NHANVIEN.MANV) >= 
(	
	SELECT COUNT(DEAN.MADA)
	FROM DEAN
)

--Câu 9. Ràng buộc ngày vào làm của nhân viên là nhân sự phòng ban phải lớn hơn ngày sinh của nhân viên đó.
--Bảng: NHANVIEN
--Mức độ: KHÓ
--RB: NGVL


--Câu 10. Ràng buộc thời gian phân công nhân viên làm đề án phải nằm trong thời gian đề án
--Bảng: DEAN
--Mức độ: KHÓ
--RB: THOIGIAN


